<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Simple T99</title>
    <!-- Import all the bootstrap css files from css folder -->
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/styles.css" />     
    <link rel="stylesheet" href="css/custom-styles.css" />

    <!-- Logo -->
    <link rel="simpleadmin-logo" href="favicon.ico" />

    <!--  Import BootStrap Javascript -->
    <script src="js/auth.js" defer></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/alpinejs.min.js" defer></script>
    <script src="js/esim-config.js" defer></script>
    <script src="js/index-esim.js" defer></script>
    <script src="js/settings.js"></script>
    <script src="js/atcommand-utils.js"></script>
    <script src="js/dark-mode.js" defer></script>
  </head>
  <body data-require-auth="true">
    <main>
      <div class="container my-4" x-data="networkSettings()" x-init="init()">
      <nav class="navbar navbar-expand-lg mt-2">
        <div class="container-fluid">
          <a class="navbar-brand" href="/">
            <span class="mb-0 h4">Simple T99</span>
          </a>
          <!-- RIGHT CONTROLS (mobile + desktop) -->
          <div class="d-flex align-items-center ms-auto gap-2">
            <!-- Dark mode MOBILE -->
            <button
              id="darkModeToggleMobile"
              class="btn btn-blink d-lg-none"
              type="button"
              aria-label="Toggle dark mode">
              <span class="darkModeIcon">ðŸŒ™</span>
            </button>
            <!-- Hamburger -->
            <button
              class="navbar-toggler"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#navbarText"
              aria-controls="navbarText"
              aria-expanded="false"
              aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <!-- Logout MOBILE -->
            <button
              class="btn btn-outline-secondary btn-sm d-lg-none"
              id="logoutButtonMobile"
              type="button"
              aria-label="Logout">
              Logout
            </button>
          </div>
          <!-- COLLAPSABLE MENU -->
          <div class="collapse navbar-collapse" id="navbarText">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
              <li class="nav-item"><a class="nav-link" href="/radio-settings.html">Radio Settings</a></li>
              <li class="nav-item"><a class="nav-link active" href="/settings.html">System Settings</a></li>
              <li class="nav-item"><a class="nav-link" href="/advanced.html">Advanced</a></li>
              <li class="nav-item"><a class="nav-link" href="/sms.html">SMS</a></li>
              <li class="nav-item"><a class="nav-link" href="/deviceinfo.html">Device Information</a></li>
              <li class="nav-item" id="esimNavItem" style="display: none;"><a class="nav-link" href="/esim.html">eSIM</a></li>                    
            </ul>
            <!-- DESKTOP RIGHT SIDE -->
            <div class="navbar-text d-none d-lg-flex align-items-center gap-3">
              <span class="badge rounded-pill fw-semibold text-uppercase" id="navUserRole"></span>
              <span class="fw-semibold" id="navUserName"></span>
              <button class="btn btn-outline-secondary" id="logoutButton">Logout</button>
              <!-- Dark mode DESKTOP -->
              <button
                id="darkModeToggleDesktop"
                class="btn btn-blink btn-sm"
                type="button"
                aria-label="Toggle dark mode">
                <span class="darkModeIcon">ðŸŒ™</span>
              </button>
            </div>
          </div>
        </div>
      </nav>

        <div class="row mt-5">
          <div class="col-12">
            
            <template x-if="loadError">
              <div class="alert alert-danger" role="alert" x-text="loadError"></div>
            </template>

            <template x-if="successMessage">
              <div class="alert alert-success" role="alert" x-text="successMessage"></div>
            </template>

            <template x-if="restartMessage">
              <div class="alert" :class="restartStatusClass" role="alert" x-text="restartMessage"></div>
            </template>

            <template x-if="isLoading">
              <div class="d-flex align-items-center gap-2">
                <div class="spinner-border" role="status" aria-hidden="true"></div>
                <span>Loading configuration...</span>
              </div>
            </template>

            <form
              x-show="!isLoading"
              @submit.prevent="saveSettings"
              data-requires-admin
            >
              <div class="row g-4">
                <!-- Left Column: IP & DHCP Settings -->
                <div class="col-lg-6">
                  <div class="card">
                    <div class="card-header">Network Configuration</div>
                    <div class="card-body">
                      
                      <!-- LAN Settings -->
                      <div class="row g-3">
                        <div class="col-md-6">
                          <label class="form-label" for="ipAddress">LAN IP address</label>
                          <input
                            id="ipAddress"
                            class="form-control"
                            type="text"
                            inputmode="decimal"
                            autocomplete="off"
                            :disabled="isSaving"
                            x-model.trim="form.ipAddress"
                            @change="handleIpChange"
                          />
                        </div>
                        <div class="col-md-6">
                          <label class="form-label" for="subnetMask">Subnet mask</label>
                          <select
                            id="subnetMask"
                            class="form-select"
                            :disabled="isSaving"
                            x-model="form.subnetMask"
                          >
                            <template x-for="option in maskOptions" :key="option.value">
                              <option :value="option.value" x-text="option.label"></option>
                            </template>
                          </select>
                        </div>
                      </div>

                      <hr class="my-4" />

                      <!-- DHCP Settings -->
                      <div class="form-check form-switch mb-3">
                        <input
                          id="dhcpEnabled"
                          class="form-check-input"
                          type="checkbox"
                          role="switch"
                          :disabled="isSaving"
                          x-model="form.dhcpEnabled"
                        />
                        <label class="form-check-label" for="dhcpEnabled">Enable DHCP server</label>
                      </div>

                      <div class="row g-3 mt-1">
                        <div class="col-md-6">
                          <label class="form-label" for="dhcpStart">DHCP range start</label>
                          <input
                            id="dhcpStart"
                            class="form-control"
                            type="text"
                            inputmode="decimal"
                            autocomplete="off"
                            :disabled="isSaving || !form.dhcpEnabled"
                            x-model.trim="form.dhcpStart"
                            @input="dhcpRangeEdited = true"
                          />
                        </div>
                        <div class="col-md-6">
                          <label class="form-label" for="dhcpEnd">DHCP range end</label>
                          <input
                            id="dhcpEnd"
                            class="form-control"
                            type="text"
                            inputmode="decimal"
                            autocomplete="off"
                            :disabled="isSaving || !form.dhcpEnabled"
                            x-model.trim="form.dhcpEnd"
                            @input="dhcpRangeEdited = true"
                          />
                        </div>
                      </div>

                      <div class="row g-3 mt-1">
                        <div class="col-md-6">
                          <label class="form-label" for="dhcpLease">Lease time (seconds)</label>
                          <input
                            id="dhcpLease"
                            class="form-control"
                            type="number"
                            min="60"
                            step="60"
                            :disabled="isSaving || !form.dhcpEnabled"
                            x-model.trim="form.dhcpLease"
                          />
                        </div>
                      </div>

                      <hr class="my-4" />

                      <!-- DMZ Settings -->
                      <div class="form-check form-switch mb-3">
                        <input
                          id="dmzEnabled"
                          class="form-check-input"
                          type="checkbox"
                          role="switch"
                          :disabled="isSaving"
                          x-model="form.dmzEnabled"
                        />
                        <label class="form-check-label" for="dmzEnabled">Enable DMZ</label>
                      </div>

                      <div class="row g-3 mt-1">
                        <div class="col-md-6">
                          <label class="form-label" for="dmzIp">DMZ client IP address</label>
                          <input
                            id="dmzIp"
                            class="form-control"
                            type="text"
                            inputmode="decimal"
                            autocomplete="off"
                            :disabled="isSaving || !form.dmzEnabled"
                            x-model.trim="form.dmzIp"
                          />
                        </div>
                      </div>

                      <hr class="my-4" />

                      <!-- Bridge Mode -->
                      <div class="form-check form-switch mb-3">
                        <input
                          id="bridgeEnabled"
                          class="form-check-input"
                          type="checkbox"
                          role="switch"
                          :disabled="isSaving"
                          x-model="form.bridgeEnabled"
                        />
                        <label class="form-check-label" for="bridgeEnabled">Enable bridge mode (IP passthrough)</label>
                      </div>

                      <div class="row g-3 mt-1">
                        <div class="col-md-8">
                          <label class="form-label" for="bridgeMac">Bridge client MAC address</label>
                          <input
                            id="bridgeMac"
                            class="form-control"
                            type="text"
                            inputmode="text"
                            autocomplete="off"
                            placeholder="AA:BB:CC:DD:EE:FF"
                            :disabled="isSaving || !form.bridgeEnabled"
                            x-model.trim="form.bridgeMac"
                            @input="form.bridgeMac = form.bridgeMac.toUpperCase()"
                          />
                          <div class="form-text">
                            When bridge mode is enabled, the selected device receives the public IP directly and the router interface remains on the LAN subnet.
                          </div>
                        </div>
                      </div>

                      <template x-if="form.bridgeEnabled">
                        <div class="alert alert-warning mt-3" role="alert">
                          While bridge mode is active, the selected client will receive its address directly from the mobile network and skip the LAN DHCP pool. Access to the router interface may only be possible from devices that remain on the LAN subnet.
                        </div>
                      </template>

                      <hr class="my-4" />

                      <!-- IPv6 -->
                      <div class="form-check form-switch mb-3">
                        <input
                          id="ipv6Enabled"
                          class="form-check-input"
                          type="checkbox"
                          role="switch"
                          :disabled="isSaving"
                          x-model="form.ipv6Enabled"
                        />
                        <label class="form-check-label" for="ipv6Enabled">Enable IPv6</label>
                      </div>

                    </div>
                  </div>
                </div>

                <!-- Right Column: TTL & Reboot -->
                <div class="col-lg-6">
                  
                  <!-- Custom TTL -->
                <div class="card">
                  <div class="card-header">Custom TTL</div>
                  <div class="card-body">

                    <template x-if="ttlSuccessMessage">
                      <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                        <span x-text="ttlSuccessMessage"></span>
                        <button type="button" class="btn-close" @click="ttlSuccessMessage = ''"></button>
                      </div>
                    </template>

                    <template x-if="ttlErrorMessage">
                      <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                        <span x-text="ttlErrorMessage"></span>
                        <button type="button" class="btn-close" @click="ttlErrorMessage = ''"></button>
                      </div>
                    </template>

                    <p class="text-body-secondary mb-3">
                      Set up a custom time-to-live for each outbound packet.
                    </p>

                    <div class="form-check form-switch mb-3">
                      <input
                        id="ttlEnabled"
                        class="form-check-input"
                        type="checkbox"
                        role="switch"
                        :disabled="ttlSaving"
                        x-model="ttlForm.enabled"
                        @change="onTTLToggle"
                      />
                      <label class="form-check-label" for="ttlEnabled">
                        Enable Custom TTL
                        <span x-show="ttlSaving" class="spinner-border spinner-border-sm ms-2" role="status"></span>
                      </label>
                    </div>

                    <div x-show="ttlForm.enabled">
                      <div class="row g-3 mt-1">
                        <div class="col-md-8">
                          <label class="form-label" for="ttlValue">TTL Value</label>
                          <div class="input-group">
                            <input
                              id="ttlValue"
                              class="form-control"
                              type="number"
                              min="1"
                              max="255"
                              inputmode="numeric"
                              autocomplete="off"
                              placeholder="64"
                              x-model.number="ttlForm.value"
                              @keydown.enter="applyTTL"
                            />
                            <button
                              class="btn btn-primary"
                              type="button"
                              :disabled="ttlSaving || !ttlForm.enabled || ttlForm.value === currentTtlSettings.value"
                              @click="applyTTL"
                            >
                              <span x-show="!ttlSaving">Apply</span>
                              <span x-show="ttlSaving">
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                              </span>
                            </button>
                          </div>
                          <div class="form-text">
                            Set a value between 1 and 255. Changes are applied immediately without restarting the modem.
                          </div>
                        </div>
                      </div>
                      
                      <template x-if="ttlForm.enabled && ttlForm.value">
                        <div class="alert alert-info mt-3" role="alert">
                          <strong>Custom TTL is applied:</strong> Packets will be sent with TTL value of <span x-text="ttlForm.value"></span>.
                        </div>
                      </template>

                    </div>
                  </div>
                </div>

                  <!-- Automatic Reboot -->
                  <div class="card mt-4">
                    <div class="card-header">Automatic reboot</div>
                    <div class="card-body">

                      <template x-if="rebootSuccessMessage">
                        <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                          <span x-text="rebootSuccessMessage"></span>
                          <button type="button" class="btn-close" @click="rebootSuccessMessage = ''"></button>
                        </div>
                      </template>

                      <template x-if="rebootErrorMessage">
                        <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                          <span x-text="rebootErrorMessage"></span>
                          <button type="button" class="btn-close" @click="rebootErrorMessage = ''"></button>
                        </div>
                      </template>

                      <p class="text-body-secondary mb-3">
                        Set up a scheduled reboot: the configuration is saved as a cron-tab job to reboot the Linux OS.
                      </p>

                      <div class="form-check form-switch mb-3 d-inline-flex align-items-center gap-2">
                        <input
                          id="rebootEnabled"
                          class="form-check-input"
                          type="checkbox"
                          role="switch"
                          :disabled="rebootSaving"
                          x-model="rebootForm.enabled"
                          @change="
                            if (!rebootForm.enabled) {
                              clearRebootSchedule()
                            }"                          
                        />
                        <label class="form-check-label mb-0" for="rebootEnabled">
                          Enable automatic reboot
                          <span x-show="rebootSaving" class="spinner-border spinner-border-sm ms-2" role="status"></span>
                        </label>
                      </div>

                      <div x-show="rebootForm.enabled">
                        <div class="row g-3">
                          <div class="col-md-7">
                            <label class="form-label d-block mb-2">When?</label>
                            <div class="btn-group mb-3" role="group" aria-label="Auto reboot options">
                              <button type="button" class="btn"
                                      :class="rebootForm.mode === 'interval' ? 'btn-primary' : 'btn-outline-primary'"
                                      @click="rebootForm.mode = 'interval'"
                                      :disabled="rebootSaving">
                                Every X hours
                              </button>
                              <button type="button" class="btn"
                                      :class="rebootForm.mode === 'schedule' ? 'btn-primary' : 'btn-outline-primary'"
                                      @click="rebootForm.mode = 'schedule'"
                                      :disabled="rebootSaving">
                                Schedule
                              </button>
                            </div>
                          </div>
                        </div>

                        <div class="row g-2" x-show="rebootForm.mode === 'interval'">
                          <div class="col-md-7">
                            <label class="form-label" for="rebootIntervalHours">Every how many hours?</label>
                            <div class="input-group">
                              <input
                                id="rebootIntervalHours"
                                class="form-control"
                                type="number"
                                min="1"
                                max="24"
                                :disabled="rebootSaving"
                                x-model.number="rebootForm.intervalHours"
                              />
                              <span class="input-group-text">hours</span>
                            </div>
                            <div class="form-text">Performs a reboot every N hours (e.g. 12 => <code>0 */12 * * * reboot</code>).</div>
                          </div>

                          <div class="col-md-5">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-primary w-100" :disabled="rebootSaving" @click="applyRebootImmediately()">
                              <span x-show="!rebootSaving">Apply</span>
                              <span x-show="rebootSaving">
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                              </span>
                            </button>
                          </div>
                        </div>

                        <div class="row g-3" x-show="rebootForm.mode === 'schedule'">
                          <div class="col-md-6">
                            <label class="form-label" for="rebootFrequency">Frequency</label>
                            <select
                              id="rebootFrequency"
                              class="form-select"
                              :disabled="rebootSaving"
                              x-model="rebootForm.frequency"
                            >
                              <option value="daily">Every day</option>
                              <option value="weekly">Every week</option>
                              <option value="monthly">Every month</option>
                            </select>
                          </div>

                          <div class="col-md-6" x-show="rebootForm.frequency === 'weekly'">
                            <label class="form-label" for="rebootDayOfWeek">Day</label>
                            <select
                              id="rebootDayOfWeek"
                              class="form-select"
                              :disabled="rebootSaving"
                              x-model="rebootForm.dayOfWeek"
                            >
                              <option value="1">Monday</option>
                              <option value="2">Tuesday</option>
                              <option value="3">Wednesday</option>
                              <option value="4">Thursday</option>
                              <option value="5">Friday</option>
                              <option value="6">Saturday</option>
                              <option value="0">Sunday</option>
                            </select>
                          </div>

                          <div class="col-md-6" x-show="rebootForm.frequency === 'monthly'">
                            <label class="form-label" for="rebootDayOfMonth">Day of the month</label>
                            <input
                              id="rebootDayOfMonth"
                              class="form-control"
                              type="number"
                              min="1"
                              max="31"
                              :disabled="rebootSaving"
                              x-model.number="rebootForm.dayOfMonth"
                            />
                            <div class="form-text">Example: 1 = the first day of every month.</div>
                          </div>

                          <div class="col-md-6">
                            <label class="form-label" for="rebootTime">Time</label>
                            <input
                              id="rebootTime"
                              class="form-control"
                              type="time"
                              step="60"
                              :disabled="rebootSaving"
                              x-model="rebootForm.time"
                            />
                            <div class="form-text">Examples: 00:00 (midnight), 16:00 (every day at 4 PM).</div>
                          </div>

                          <div class="col-12">
                            <button type="button" class="btn btn-primary w-100" :disabled="rebootSaving" @click="applyRebootImmediately()">
                              <span x-show="!rebootSaving">Apply</span>
                              <span x-show="rebootSaving">
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                              </span>
                            </button>
                          </div>
                        </div>

                        <template x-if="rebootSchedule && rebootForm.enabled">
                          <div class="alert alert-info mt-3" role="alert">
                            <strong>Current schedule:</strong>
                            <code x-text="rebootSchedule"></code>
                          </div>
                        </template>

                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Validation and Action Buttons -->
              <div class="row mt-4">
                <div class="col-12">
                  <template x-if="validationErrors.length">
                    <div class="alert alert-warning" role="alert">
                      <h6 class="alert-heading">Please review the following:</h6>
                      <ul class="mb-0">
                        <template x-for="(error, index) in validationErrors" :key="index">
                          <li x-text="error"></li>
                        </template>
                      </ul>
                    </div>
                  </template>

                  <div class="card">
                    <div class="card-footer">
                      <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                          Saving the configuration will restart the modem to apply the changes.
                        </small>
                        <div class="d-flex gap-2">
                          <a href="/credentials.html" class="btn btn-info">Credential Management</a>                          
                          <button type="button" class="btn btn-danger" :disabled="isSaving" @click="resetForm">Reset</button>
                          <button type="submit" class="btn btn-primary" :disabled="isSaving">
                            <template x-if="!isSaving">
                              <span>Save changes</span>
                            </template>
                            <template x-if="isSaving">
                              <span class="d-flex align-items-center gap-2">
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <span>Saving...</span>
                              </span>
                            </template>
                          </button>                    
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </main>
  </body>
</html>