#!/bin/bash
set -eu

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
. "$SCRIPT_DIR/session_utils.sh"

if ! session_load; then
    send_json_response 401 '{"status":"error","message":"Authentication required"}'
    exit 0
fi

# Check iptables for ttlvalue
ttlvalue=$(/usr/sbin/iptables -w 5 -t mangle -vnL | grep TTL | awk '{print $13}' | head -n1)
ttlenabled=true

# Set Variables
if [ -z "${ttlvalue}" ]; then
    ttlvalue=0
    ttlenabled=false
fi

# Build JSON payload
json_payload=$(cat <<EOF
{
  "status":"ok",
  "isEnabled":${ttlenabled},
  "ttl":${ttlvalue}
}
EOF
)

send_json_response 200 "$json_payload"