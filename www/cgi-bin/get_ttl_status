#!/bin/bash
set -eu

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
. "$SCRIPT_DIR/session_utils.sh"

if ! session_load; then
    printf 'Status: 401 Unauthorized\r\n'
    printf 'Content-type: application/json\r\n\r\n'
    printf '{"success":false,"message":"Authentication required"}\n'
    exit 0
fi

# Check iptables for ttlvalue
ttlvalue=$(/usr/sbin/iptables -w 5 -t mangle -vnL | grep TTL | awk '{print $13}' | head -n1)
ttlenabled=true;

# Set Variables
if [ -z "${ttlvalue}" ]; then
    ttlvalue=0
    ttlenabled=false
fi

echo "Content-type: text/json" 
echo ""
cat <<EOT
{
    "isEnabled": $ttlenabled,
    "ttl": $ttlvalue
}
EOT
