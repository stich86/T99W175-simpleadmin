#!/bin/bash
set -u

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
. "$SCRIPT_DIR/session_utils.sh"

if ! session_load; then
    send_json_response 401 '{"ok":false,"message":"Authentication required"}'
    exit 0
fi

# Read POST data
POST_DATA="$(cat)"

# Extract parameters
IMEI=$(echo "$POST_DATA" | sed -n 's/.*"imei"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')
SLOT=$(echo "$POST_DATA" | sed -n 's/.*"slot"[[:space:]]*:[[:space:]]*\([0-9]\+\).*/\1/p')
REFRESH=$(echo "$POST_DATA" | sed -n 's/.*"refresh"[[:space:]]*:[[:space:]]*\(true\|false\).*/\1/p')

CONFIG_FILE="/home/root/client.yaml"
SERVICE_NAME="euicc"

# Validate inputs
if [ -z "$IMEI" ] || [ -z "$SLOT" ] || [ -z "$REFRESH" ]; then
    send_json_response 400 '{"ok":false,"message":"Missing required parameters"}'
    exit 1
fi

# Validate IMEI (15 digits)
if ! echo "$IMEI" | grep -qE '^[0-9]{15}$'; then
    send_json_response 400 '{"ok":false,"message":"Invalid IMEI format (must be 15 digits)"}'
    exit 1
fi

# Validate slot (1 or 2)
if [ "$SLOT" != "1" ] && [ "$SLOT" != "2" ]; then
    send_json_response 400 '{"ok":false,"message":"Invalid slot (must be 1 or 2)"}'
    exit 1
fi

# Check if config file exists
if [ ! -f "$CONFIG_FILE" ]; then
    send_json_response 404 '{"ok":false,"message":"Configuration file not found"}'
    exit 1
fi

# Backup original config
cp "$CONFIG_FILE" "${CONFIG_FILE}.bak"

# Update the YAML file using sed
sed -i "s/^  imei: .*/  imei: \"$IMEI\"/" "$CONFIG_FILE"
sed -i "s/^  slot: .*/  slot: $SLOT/" "$CONFIG_FILE"
sed -i "s/^  refresh: .*/  refresh: $REFRESH/" "$CONFIG_FILE"

# Verify changes
if ! grep -q "imei: \"$IMEI\"" "$CONFIG_FILE" || \
   ! grep -q "slot: $SLOT" "$CONFIG_FILE" || \
   ! grep -q "refresh: $REFRESH" "$CONFIG_FILE"; then
    # Restore backup
    mv "${CONFIG_FILE}.bak" "$CONFIG_FILE"
    send_json_response 500 '{"ok":false,"message":"Failed to update configuration"}'
    exit 1
fi

# Remove backup
rm -f "${CONFIG_FILE}.bak"

# Restart the service
systemctl restart "$SERVICE_NAME" 2>&1

if systemctl is-active --quiet "$SERVICE_NAME"; then
    send_json_response 200 '{"ok":true,"message":"Configuration updated and service restarted successfully"}'
else
    send_json_response 500 '{"ok":false,"message":"Configuration updated but service failed to restart"}'
    exit 1
fi