#!/bin/bash
set -eu

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
. "$SCRIPT_DIR/session_utils.sh"

ensure_credentials_file
ensure_session_store

unauthorized() {
    send_json_response 403 '{"success":false,"message":"Admin privileges required"}'
}

bad_request() {
    send_json_response 400 '{"success":false,"message":"Invalid request"}'
}

read_body() {
    local length="${CONTENT_LENGTH:-0}"
    if [ "$length" -gt 0 ]; then
        head -c "$length"
    else
        cat
    fi
}

urldecode() {
    local data="${1//+/ }"
    printf '%b' "${data//%/\\x}"
}

if ! session_load; then
    send_json_response 401 '{"success":false,"message":"Authentication required"}'
    exit 0
fi

if ! session_require_role "admin"; then
    unauthorized
    exit 0
fi

action="${QUERY_STRING:-}" 
if [ -n "$action" ]; then
    IFS='&' read -r -a qs_pairs <<< "$action"
    for pair in "${qs_pairs[@]}"; do
        key="${pair%%=*}"
        value="${pair#*=}"
        if [ "$key" = "action" ]; then
            action="$(urldecode "$value")"
        fi
    done
fi

if [ -z "$action" ]; then
    action=""
fi

if [ "${REQUEST_METHOD:-GET}" = "GET" ]; then
    if [ "$action" = "list" ] || [ -z "$action" ]; then
        users_json="$(list_users)"
        send_json_response 200 "{\"success\":true,\"data\":$users_json}"
    else
        bad_request
    fi
    exit 0
fi

if [ "${REQUEST_METHOD:-GET}" != "POST" ]; then
    send_json_response 405 '{"success":false,"message":"Method not allowed"}'
    exit 0
fi

raw_body="$(read_body)"

declare -A form
IFS='&' read -r -a body_pairs <<< "$raw_body"
for pair in "${body_pairs[@]}"; do
    key="${pair%%=*}"
    value="${pair#*=}"
    form["$key"]="$(urldecode "$value")"
done

action="${form[action]:-$action}"

case "$action" in
    add)
        username="${form[username]:-}"
        password="${form[password]:-}"
        role="${form[role]:-user}"
        if [ -z "$username" ] || [ -z "$password" ]; then
            bad_request
            exit 0
        fi
        if add_user "$username" "$role" "$password"; then
            send_json_response 200 '{"success":true,"message":"User added"}'
        else
            status=$?
            if [ $status -eq 1 ]; then
                send_json_response 409 '{"success":false,"message":"User already exists"}'
            elif [ $status -eq 2 ]; then
                send_json_response 400 '{"success":false,"message":"Invalid username"}'
            elif [ $status -eq 3 ]; then
                send_json_response 400 '{"success":false,"message":"Invalid role"}'
            else
                send_json_response 500 '{"success":false,"message":"Unable to add user"}'
            fi
        fi
        ;;
    update_password)
        username="${form[username]:-}"
        password="${form[password]:-}"
        if [ -z "$username" ] || [ -z "$password" ]; then
            bad_request
            exit 0
        fi
        if update_password "$username" "$password"; then
            send_json_response 200 '{"success":true,"message":"Password updated"}'
        else
            status=$?
            if [ $status -eq 1 ]; then
                send_json_response 404 '{"success":false,"message":"User not found"}'
            else
                send_json_response 500 '{"success":false,"message":"Unable to update password"}'
            fi
        fi
        ;;
    update_role)
        username="${form[username]:-}"
        role="${form[role]:-}"
        if [ -z "$username" ] || [ -z "$role" ]; then
            bad_request
            exit 0
        fi
        if update_role "$username" "$role"; then
            send_json_response 200 '{"success":true,"message":"Role updated"}'
        else
            status=$?
            if [ $status -eq 1 ]; then
                send_json_response 404 '{"success":false,"message":"User not found"}'
            elif [ $status -eq 2 ]; then
                send_json_response 400 '{"success":false,"message":"Invalid role"}'
            else
                send_json_response 500 '{"success":false,"message":"Unable to update role"}'
            fi
        fi
        ;;
    delete)
        username="${form[username]:-}"
        if [ -z "$username" ]; then
            bad_request
            exit 0
        fi
        if delete_user "$username"; then
            send_json_response 200 '{"success":true,"message":"User removed"}'
        else
            status=$?
            if [ $status -eq 1 ]; then
                send_json_response 404 '{"success":false,"message":"User not found"}'
            elif [ $status -eq 2 ]; then
                send_json_response 409 '{"success":false,"message":"Cannot remove the last admin"}'
            else
                send_json_response 500 '{"success":false,"message":"Unable to remove user"}'
            fi
        fi
        ;;
    *)
        bad_request
        ;;
esac
