#!/bin/bash
set -u
set -o pipefail

urldecode() {
    local data="${1//+/ }"
    printf '%b' "${data//%/\\x}"
}

strip_ansi() {
    sed -E 's/\x1B\[[0-9;]*[mG]//g'
}

print_headers() {
    printf 'Content-type: text/plain\n\n'
}

raw_query="${QUERY_STRING:-}"
clean_query="${raw_query//;/}"

atcmd_param=""
if [ -n "$clean_query" ]; then
    IFS='&' read -r -a pairs <<< "$clean_query"
    for pair in "${pairs[@]}"; do
        [ -z "$pair" ] && continue
        key="${pair%%=*}"
        value=""
        if [[ "$pair" == *"="* ]]; then
            value="${pair#*=}"
        fi
        if [ "$key" = "atcmd" ]; then
            atcmd_param="$value"
            break
        fi
    done
fi

if [ -z "$atcmd_param" ]; then
    print_headers
    printf 'ERROR\n\nMissing atcmd parameter.\n'
    exit 0
fi

decoded_atcmd="$(urldecode "$atcmd_param")"
if [ -z "$decoded_atcmd" ]; then
    print_headers
    printf 'ERROR\n\nUnable to decode the atcmd parameter.\n'
    exit 0
fi

if ! command -v atcli_smd8 >/dev/null 2>&1; then
    print_headers
    printf '%s\n\nERROR: atcli_smd8 command not found.\n' "$decoded_atcmd"
    exit 0
fi

command_output=""
exit_code=0
if ! command_output=$(atcli_smd8 "$decoded_atcmd" 2>&1); then
    exit_code=$?
fi

clean_output=$(printf '%s\n' "$command_output" | strip_ansi)

print_headers
printf '%s\n\n' "$decoded_atcmd"

if [ -n "$clean_output" ]; then
    printf '%s\n' "$clean_output"
else
    if [ $exit_code -ne 0 ]; then
        printf 'ERROR: atcli_smd8 exited with code %s.\n' "$exit_code"
    else
        printf 'ERROR: empty response from modem.\n'
    fi
fi
