#!/bin/bash
set -u
set -o pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
. "$SCRIPT_DIR/session_utils.sh"

if ! session_load; then
    send_json_response 401 '{"success":false,"message":"Authentication required"}'
    exit 0
fi

if ! session_require_role "admin"; then
    send_json_response 403 '{"success":false,"message":"Admin privileges required"}'
    exit 0
fi

# URL decode helper
urldecode() {
    local data="${1//+/ }"
    printf '%b' "${data//%/\\x}"
}

# Strip ANSI escape codes
strip_ansi() {
    sed -E 's/\x1B\[[0-9;]*[mG]//g'
}

# JSON escape helper
json_escape() {
    local str="$1"
    str="${str//\\/\\\\}"
    str="${str//\"/\\\"}"
    str="${str//$'\n'/\\n}"
    str="${str//$'\r'/\\r}"
    str="${str//$'\t'/\\t}"
    printf '%s' "$str"
}

# Parse query string
raw_query="${QUERY_STRING:-}"
clean_query="${raw_query//;/}"

atcmd_param=""
if [ -n "$clean_query" ]; then
    IFS='&' read -r -a pairs <<< "$clean_query"
    for pair in "${pairs[@]}"; do
        [ -z "$pair" ] && continue
        key="${pair%%=*}"
        value=""
        if [[ "$pair" == *"="* ]]; then
            value="${pair#*=}"
        fi
        if [ "$key" = "atcmd" ]; then
            atcmd_param="$value"
            break
        fi
    done
fi

# Validate atcmd parameter
if [ -z "$atcmd_param" ]; then
    send_json_response 400 '{"success":false,"message":"Missing atcmd parameter"}'
    exit 0
fi

# Decode the AT command
decoded_atcmd="$(urldecode "$atcmd_param")"
if [ -z "$decoded_atcmd" ]; then
    send_json_response 400 '{"success":false,"message":"Unable to decode the atcmd parameter"}'
    exit 0
fi

# Check if atcli_smd8 command exists
if ! command -v atcli_smd8 >/dev/null 2>&1; then
    send_json_response 500 '{"success":false,"message":"atcli_smd8 command not found"}'
    exit 0
fi

# Execute the AT command
command_output=""
exit_code=0
if ! command_output=$(atcli_smd8 "$decoded_atcmd" 2>&1); then
    exit_code=$?
fi

# Clean ANSI codes from output
clean_output=$(printf '%s' "$command_output" | strip_ansi)

# Prepare response
if [ -z "$clean_output" ]; then
    if [ $exit_code -ne 0 ]; then
        error_msg="atcli_smd8 exited with code $exit_code"
    else
        error_msg="Empty response from modem"
    fi
    send_json_response 500 "{\"success\":false,\"message\":\"$error_msg\",\"command\":\"$(json_escape "$decoded_atcmd")\",\"exit_code\":$exit_code}"
    exit 0
fi

# Success response
escaped_command=$(json_escape "$decoded_atcmd")
escaped_output=$(json_escape "$clean_output")

payload=$(cat <<EOF
{
  "success":true,
  "command":"$escaped_command",
  "output":"$escaped_output",
  "exit_code":$exit_code
}
EOF
)

send_json_response 200 "$payload"