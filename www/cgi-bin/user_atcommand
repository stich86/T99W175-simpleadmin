#!/bin/bash
set -u
set -o pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
. "$SCRIPT_DIR/session_utils.sh"

if ! session_load; then
    send_json_response 401 '{"success":false,"message":"Authentication required"}'
    exit 0
fi

if ! session_require_role "admin"; then
    send_json_response 403 '{"success":false,"message":"Admin privileges required"}'
    exit 0
fi

# URL decode helper
urldecode() {
    local data="${1//+/ }"
    printf '%b' "${data//%/\\x}"
}

# Strip ANSI escape codes
strip_ansi() {
    sed -E 's/\x1B\[[0-9;]*[mG]//g'
}

# Parse query string
raw_query="${QUERY_STRING:-}"
clean_query="${raw_query//;/}"

atcmd_param=""
if [ -n "$clean_query" ]; then
    IFS='&' read -r -a pairs <<< "$clean_query"
    for pair in "${pairs[@]}"; do
        [ -z "$pair" ] && continue
        key="${pair%%=*}"
        value=""
        if [[ "$pair" == *"="* ]]; then
            value="${pair#*=}"
        fi
        if [ "$key" = "atcmd" ]; then
            atcmd_param="$value"
            break
        fi
    done
fi

# Validate atcmd parameter
if [ -z "$atcmd_param" ]; then
    send_json_response 400 '{"success":false,"message":"Missing atcmd parameter"}'
    exit 0
fi

# Decode the AT command
decoded_atcmd="$(urldecode "$atcmd_param")"
if [ -z "$decoded_atcmd" ]; then
    send_json_response 400 '{"success":false,"message":"Unable to decode the atcmd parameter"}'
    exit 0
fi

# Resolve AT CLI binary (prefer smd11-specific if present)
ATCLI_BIN=""
if [ -x /usrdata/simpleadmin/atcli ]; then
    ATCLI_BIN="/usrdata/simpleadmin/atcli"
elif command -v atcli >/dev/null 2>&1; then
    ATCLI_BIN="$(command -v atcli)"
elif [ -x /usrdata/simpleadmin/atcli_smd11 ]; then
    ATCLI_BIN="/usrdata/simpleadmin/atcli_smd11"
elif command -v atcli_smd11 >/dev/null 2>&1; then
    ATCLI_BIN="$(command -v atcli_smd11)"
fi

if [ -z "$ATCLI_BIN" ]; then
    send_json_response 500 '{"success":false,"message":"atcli command not found"}'
    exit 0
fi

# Execute the AT command
command_output=""
exit_code=0
if ! command_output=$("$ATCLI_BIN" "$decoded_atcmd" 2>&1); then
    exit_code=$?
fi

# Clean ANSI codes from output
clean_output=$(printf '%s' "$command_output" | strip_ansi)

# Prepare response
if [ -z "$clean_output" ]; then
    if [ $exit_code -ne 0 ]; then
        error_msg="atcli exited with code $exit_code"
    else
        error_msg="Empty response from modem"
    fi
    send_json_response 500 "{\"success\":false,\"message\":\"$error_msg\",\"command\":\"$(json_escape "$decoded_atcmd")\",\"exit_code\":$exit_code}"
    exit 0
fi

# Success response
escaped_command=$(json_escape "$decoded_atcmd")
escaped_output=$(json_escape "$clean_output")

payload=$(cat <<EOF
{
  "success":true,
  "command":"$escaped_command",
  "output":"$escaped_output",
  "exit_code":$exit_code
}
EOF
)

send_json_response 200 "$payload"
