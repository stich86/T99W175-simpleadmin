#!/bin/bash

# SimpleAdmin Update System - Apply Update
# Updates state to 'updating', launches worker, returns immediately
# Worker completes update and updates state to 'success'/'error'

SCRIPT_DIR="/WEBSERVER/www/cgi-bin"
STATE_DIR="/data/simpleadmin"
STATE_FILE="${STATE_DIR}/update-state.json"
WWW_DIR="/WEBSERVER/www"

# Log start
echo "[$(date '+%Y-%m-%d %H:%M:%S')] apply_update: Started" >> /tmp/simpleadmin-fota.log 2>/dev/null || true

# Source session utilities (disable set -e)
set +e
. "$SCRIPT_DIR/session_utils.sh"
set -e 2>/dev/null || true

# Validate session
if ! session_load; then
    echo "Status: 401 Unauthorized"
    echo "Content-type: application/json"
    echo ""
    echo '{"ok": false, "message": "Invalid or expired session"}'
    exit 1
fi

if ! session_require_role "admin"; then
    echo "Status: 403 Forbidden"
    echo "Content-type: application/json"
    echo ""
    echo '{"ok": false, "message": "Admin privileges required"}'
    exit 1
fi

# Extract field from JSON
extract_json_field() {
    local json=$1
    local field=$2
    echo "$json" | grep "\"$field\":" | sed 's/.*"'$field'" *: *"\([^"]*\)".*/\1/' | head -n 1
}

extract_json_bool() {
    local json=$1
    local field=$2
    echo "$json" | grep "\"$field\":" | sed 's/.*"'$field'" *: *\([^,}]*\).*/\1/' | head -n 1
}

# Read state
state_data=$(cat "$STATE_FILE" 2>/dev/null)

if [ -z "$state_data" ]; then
    echo "Status: 200 OK"
    echo "Content-type: application/json"
    echo ""
    echo '{"ok": false, "message": "State file not found"}'
    exit 1
fi

# Extract fields
update_downloaded=$(extract_json_bool "$state_data" "update_downloaded")
download_path=$(extract_json_field "$state_data" "download_path")
latest_version=$(extract_json_field "$state_data" "latest_version")
current_version=$(extract_json_field "$state_data" "current_version")

# Validate
if [ "$update_downloaded" != "true" ]; then
    echo "Status: 200 OK"
    echo "Content-type: application/json"
    echo ""
    echo '{"ok": false, "message": "Update not downloaded"}'
    exit 1
fi

if [ -z "$download_path" ] || [ ! -f "$download_path" ]; then
    echo "Status: 200 OK"
    echo "Content-type: application/json"
    echo ""
    echo '{"ok": false, "message": "Download file not found"}'
    exit 1
fi

if [ ! -f "$SCRIPT_DIR/fota/apply_update_worker.sh" ]; then
    echo "Status: 200 OK"
    echo "Content-type: application/json"
    echo ""
    echo '{"ok": false, "message": "Worker script not found"}'
    exit 1
fi

# Validate version
if [ -z "$latest_version" ] || [ "$latest_version" = "null" ]; then
    latest_version="$current_version"
fi

# Copy worker to /tmp (outside www so it survives rename)
WORKER_SOURCE="$SCRIPT_DIR/fota/apply_update_worker.sh"
WORKER_TARGET="/tmp/apply_update_worker_$$.sh"

if ! cp "$WORKER_SOURCE" "$WORKER_TARGET" 2>/dev/null; then
    echo "Status: 200 OK"
    echo "Content-type: application/json"
    echo ""
    echo '{"ok": false, "message": "Failed to copy worker script"}'
    exit 1
fi

chmod +x "$WORKER_TARGET"

# Check systemd-run
if ! which systemd-run >/dev/null 2>&1; then
    rm -f "$WORKER_TARGET"
    echo "Status: 200 OK"
    echo "Content-type: application/json"
    echo ""
    echo '{"ok": false, "message": "systemd-run not available"}'
    exit 1
fi

# Update state to 'updating' BEFORE launching worker
# This is the critical moment - state must be updated before response
sed -i 's/"status": "[^"]*"/"status": "updating"/' "$STATE_FILE" 2>/dev/null

# Launch worker via systemd-run
systemd-run --quiet --scope \
    "$WORKER_TARGET" "$download_path" "$current_version" >/dev/null 2>&1

if [ $? -ne 0 ]; then
    rm -f "$WORKER_TARGET"
    sed -i 's/"status": "[^"]*"/"status": "error"/' "$STATE_FILE" 2>/dev/null
    echo "Status: 200 OK"
    echo "Content-type: application/json"
    echo ""
    echo '{"ok": false, "message": "Failed to start worker"}'
    exit 1
fi

# Return success with refresh instruction
cat <<EOF
Status: 200 OK
Content-type: application/json
Cache-Control: no-store

{
  "ok": true,
  "refresh_after": 30,
  "message": "Update started in background. Page will refresh automatically.",
  "data": {
    "version": "$latest_version",
    "current_version": "$current_version"
  }
}
EOF
