#!/bin/bash

# SimpleAdmin FOTA - Apply Update
# Updates state to 'updating', launches worker, IMMEDIATELY returns response
# Worker waits before executing to ensure response is sent

SCRIPT_DIR="/WEBSERVER/www/cgi-bin"
STATE_DIR="/data/simpleadmin"
STATE_FILE="${STATE_DIR}/update-state.json"
WWW_DIR="/WEBSERVER/www"

# Logging
exec 2>/tmp/simpleadmin-fota-stderr.log
echo "[$(date)] apply_update START" >> /tmp/simpleadmin-fota-exec.log

# Response function
send_response() {
    local ok=$1
    local msg=$2
    local refresh=$3
    local ver=$4

    cat <<EOF
Status: 200 OK
Content-type: application/json
Cache-Control: no-store

{"ok": $ok, "message": "$msg", "refresh_after": $refresh, "data": {"version": "$ver"}}
EOF
}

# Source session utils
set +e +u
. "$SCRIPT_DIR/session_utils.sh" 2>/dev/null || true
set -e 2>/dev/null || true

# Validate session
session_load 2>/dev/null || { send_response "false" "Invalid session" "0" ""; exit 1; }
session_require_role "admin" 2>/dev/null || { send_response "false" "Admin required" "0" ""; exit 1; }

# JSON helpers
extract_json_field() {
    echo "$1" | grep "\"$2\":" | sed 's/.*"'$2'" *: *"\([^"]*\)".*/\1/' | head -n 1
}

extract_json_bool() {
    echo "$1" | grep "\"$2\":" | sed 's/.*"'$2'" *: *\([^,}]*\).*/\1/' | head -n 1
}

# Read state
[ -f "$STATE_FILE" ] || { send_response "false" "State file not found" "0" ""; exit 1; }
state_data=$(cat "$STATE_FILE" 2>/dev/null)

# Extract fields
update_downloaded=$(extract_json_bool "$state_data" "update_downloaded")
download_path=$(extract_json_field "$state_data" "download_path")
latest_version=$(extract_json_field "$state_data" "latest_version")
current_version=$(extract_json_field "$state_data" "current_version")

# Validate
[ "$update_downloaded" = "true" ] || { send_response "false" "Update not downloaded" "0" ""; exit 1; }
[ -n "$download_path" ] && [ -f "$download_path" ] || { send_response "false" "Download file not found" "0" ""; exit 1; }
[ -f "$SCRIPT_DIR/fota/apply_update_worker.sh" ] || { send_response "false" "Worker script not found" "0" ""; exit 1; }

[ -z "$latest_version" ] || [ "$latest_version" = "null" ] && latest_version="$current_version"

# Copy worker to /tmp
WORKER_SOURCE="$SCRIPT_DIR/fota/apply_update_worker.sh"
WORKER_TARGET="/tmp/apply_update_worker_$$.sh"

cp "$WORKER_SOURCE" "$WORKER_TARGET" 2>/dev/null || { send_response "false" "Failed to copy worker" "0" ""; exit 1; }
chmod +x "$WORKER_TARGET" 2>/dev/null

# Check systemd-run
which systemd-run >/dev/null 2>&1 || { send_response "false" "systemd-run not available" "0" ""; exit 1; }

# Update state to 'updating'
sed -i 's/"status": "[^"]*"/"status": "updating"/' "$STATE_FILE" 2>/dev/null || true

# Launch worker in background (detached)
systemd-run --quiet --scope "$WORKER_TARGET" "$download_path" "$current_version" >/dev/null 2>&1 &

# CRITICAL: Send response IMMEDIATELY after launching worker
# The worker will wait 2 seconds before starting, giving us time to respond
send_response "true" "Update started in background. Page will refresh." "30" "$latest_version"

echo "[$(date)] Response sent, worker launched" >> /tmp/simpleadmin-fota-exec.log

# Exit immediately after sending response
exit 0
