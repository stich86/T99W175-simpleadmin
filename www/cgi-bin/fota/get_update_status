#!/bin/bash

# SimpleAdmin Update System - Get Update Status
# Returns current update state

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source session utilities
if [ -f "$SCRIPT_DIR/../session_utils.sh" ]; then
    . "$SCRIPT_DIR/../session_utils.sh"
else
    send_json_response 500 '{"ok": false, "message": "session_utils.sh not found"}'
    exit 1
fi

# Validate session and require admin
if ! session_load; then
    send_json_response 401 '{"ok": false, "message": "Invalid or expired session"}'
    exit 1
fi

if ! session_require_role "admin"; then
    send_json_response 403 '{"ok": false, "message": "Admin privileges required"}'
    exit 1
fi

# Configuration
STATE_DIR="/data/simpleadmin"
STATE_FILE="${STATE_DIR}/update-state.json"

# Main execution
main() {
    # Check if state file exists
    if [ ! -f "$STATE_FILE" ]; then
        # Return empty state with default channel
        send_json_response 200 '{
  "channel": "stable",
  "current_version": "",
  "latest_version": "",
  "update_available": false,
  "update_downloaded": false,
  "backup_created": false,
  "backup_path": "",
  "download_path": "",
  "status": "idle",
  "last_check": "",
  "download_url": "",
  "changelog": "",
  "error_message": "No update state found. Please check for updates first."
}'
        exit 0
    fi

    # Read and output state with proper headers
    send_json_response 200 "$(cat "$STATE_FILE")"
}

# Execute main function
main
