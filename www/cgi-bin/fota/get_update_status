#!/bin/bash

# SimpleAdmin Update System - Get Update Status
# Returns current update state, optionally resets status to idle

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source session utilities
if [ -f "$SCRIPT_DIR/../session_utils.sh" ]; then
    . "$SCRIPT_DIR/../session_utils.sh"
else
    send_json_response 500 '{"ok": false, "message": "session_utils.sh not found"}'
    exit 1
fi

# Validate session and require admin
if ! session_load; then
    send_json_response 401 '{"ok": false, "message": "Invalid or expired session"}'
    exit 1
fi

if ! session_require_role "admin"; then
    send_json_response 403 '{"ok": false, "message": "Admin privileges required"}'
    exit 1
fi

# Configuration
STATE_DIR="/data/simpleadmin"
STATE_FILE="${STATE_DIR}/update-state.json"

# Parse query parameters
QUERY_STRING="${QUERY_STRING:-}"
RESET_STATUS=""

# Parse query string
if [ -n "$QUERY_STRING" ]; then
    for param in $(echo "$QUERY_STRING" | tr '&' ' '); do
        key=$(echo "$param" | cut -d'=' -f1)
        value=$(echo "$param" | cut -d'=' -f2)
        case "$key" in
            reset) RESET_STATUS="$value" ;;
        esac
    done
fi

# Main execution
main() {
    # Check if state file exists
    if [ ! -f "$STATE_FILE" ]; then
        # Return empty state with default channel
        send_json_response 200 '{
  "channel": "stable",
  "current_version": "",
  "latest_version": "",
  "update_available": false,
  "update_downloaded": false,
  "backup_created": false,
  "backup_path": "",
  "download_path": "",
  "status": "idle",
  "last_check": "",
  "download_url": "",
  "changelog": "",
  "error_message": "No update state found. Please check for updates first."
}'
        exit 0
    fi

    # Read state
    state_data=$(cat "$STATE_FILE" 2>/dev/null)

    # Output state
    send_json_response 200 "$state_data"

    # Reset status to idle if requested
    if [ "$RESET_STATUS" = "true" ]; then
        sleep 0.1  # Small delay to ensure response is sent
        # Reset status, error_message, downloaded flag, and update_available
        # KEEP: backup_created, backup_path, current_version, latest_version
        sed -i 's/"status": "[^"]*"/"status": "idle"/' "$STATE_FILE" 2>/dev/null
        sed -i 's/"error_message": "[^"]*"/"error_message": ""/' "$STATE_FILE" 2>/dev/null
        sed -i 's/"update_downloaded": [^,}]*/"update_downloaded": false/' "$STATE_FILE" 2>/dev/null
        sed -i 's/"update_available": [^,}]*/"update_available": false/' "$STATE_FILE" 2>/dev/null
    fi
}

# Execute main function
main
