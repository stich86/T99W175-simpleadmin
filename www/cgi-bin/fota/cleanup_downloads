#!/bin/bash

# SimpleAdmin FOTA System - Cleanup Downloads
# Removes old downloaded update files to free up space

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source session utilities
if [ -f "$SCRIPT_DIR/../session_utils.sh" ]; then
    . "$SCRIPT_DIR/../session_utils.sh"
else
    send_json_response 500 '{"ok": false, "message": "session_utils.sh not found"}'
    exit 1
fi

# Validate session and require admin
if ! session_load; then
    send_json_response 401 '{"ok": false, "message": "Invalid or expired session"}'
    exit 1
fi

if ! session_require_role "admin"; then
    send_json_response 403 '{"ok": false, "message": "Admin privileges required"}'
    exit 1
fi

# Configuration
STATE_DIR="/data/simpleadmin"
DOWNLOAD_DIR="${STATE_DIR}/downloads"
BACKUP_DIR="${STATE_DIR}/backups"

# Keep last N downloads
KEEP_DOWNLOADS=2

# Helper functions
send_fota_response() {
    local ok=$1
    local message=$2
    local data=$3

    local payload
    payload="{\"ok\": $ok, \"message\": \"$message\", \"data\": $data}"

    send_json_response 200 "$payload"
}

log_info() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] INFO: $1" >&2
}

# Cleanup old downloads
cleanup_downloads() {
    log_info "Cleaning up old downloads..."

    if [ ! -d "$DOWNLOAD_DIR" ]; then
        log_info "Download directory not found"
        return 0
    fi

    local count=0
    local freed_space=0

    # List files by modification time (newest first) and keep only the newest N
    ls -t "$DOWNLOAD_DIR"/*.tar.gz 2>/dev/null | tail -n +$(($KEEP_DOWNLOADS + 1)) | while read -r file; do
        if [ -f "$file" ]; then
            local size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null)
            rm -f "$file"
            freed_space=$((freed_space + size))
            count=$((count + 1))
            log_info "  Removed: $(basename "$file")"
        fi
    done

    log_info "Cleaned up $count file(s), freed $((freed_space / 1024 / 1024))MB"
}

# Get disk usage info
get_disk_usage() {
    df -m "$STATE_DIR" | awk 'NR==2 {printf "{\"total_mb\": %d, \"used_mb\": %d, \"available_mb\": %d, \"usage_percent\": %d}", $2, $3, $4, ($3*100/$2)}'
}

# Main execution
main() {
    # Create directories if needed
    mkdir -p "$DOWNLOAD_DIR"

    cleanup_downloads

    # Get updated disk usage
    local disk_usage
    disk_usage=$(get_disk_usage)

    send_fota_response "true" "Cleanup completed" "{\"disk_usage\": $disk_usage}"
}

# Execute main function
main
