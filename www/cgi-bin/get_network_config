#!/bin/bash
set -euo pipefail

CONFIG_FILE="/etc/data/mobileap_cfg.xml"

get_xml_value() {
    local key=$1
    local file=$2
    local value

    value=$(grep "<$key>" "$file" | sed "s/.*<$key>\(.*\)<\/$key>.*/\1/" | tr -d ' ')
    echo "$value"
}

output_json() {
    local ip=$1
    local subnet=$2
    local dhcp_enabled=$3
    local dhcp_start=$4
    local dhcp_end=$5
    local lease_time=$6

    cat <<JSON
Content-type: application/json

{
  "ip": "${ip}",
  "subnet": "${subnet}",
  "dhcpEnabled": "${dhcp_enabled}",
  "dhcpStart": "${dhcp_start}",
  "dhcpEnd": "${dhcp_end}",
  "leaseTime": "${lease_time}"
}
JSON
}

main() {
    if [ ! -f "$CONFIG_FILE" ]; then
        cat <<JSON
Content-type: application/json

{
  "error": "Configuration file not found"
}
JSON
        exit 0
    fi

    local ip subnet dhcp_enabled dhcp_start dhcp_end lease_time
    ip=$(get_xml_value "APIPAddr" "$CONFIG_FILE")
    subnet=$(get_xml_value "SubNetMask" "$CONFIG_FILE")
    dhcp_enabled=$(get_xml_value "EnableDHCPServer" "$CONFIG_FILE")
    dhcp_start=$(get_xml_value "StartIP" "$CONFIG_FILE")
    dhcp_end=$(get_xml_value "EndIP" "$CONFIG_FILE")
    lease_time=$(get_xml_value "LeaseTime" "$CONFIG_FILE")

    output_json "${ip:-}" "${subnet:-}" "${dhcp_enabled:-}" "${dhcp_start:-}" "${dhcp_end:-}" "${lease_time:-}"
}

main "$@"
