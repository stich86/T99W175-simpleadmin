#!/bin/bash
set -eu

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
. "$SCRIPT_DIR/session_utils.sh"

if ! session_load; then
  printf 'Status: 401 Unauthorized\r\n'
  printf 'Content-type: text/plain\r\n\r\n'
  printf 'Authentication required\n'
  exit 0
fi

echo "Content-Type: application/json"
echo "Access-Control-Allow-Origin: *"
echo ""

CONFIG_FILE="/home/root/client.yaml"

# Check if config file exists
if [ ! -f "$CONFIG_FILE" ]; then
  echo '{"ok": false, "message": "Configuration file not found"}'
  exit 1
fi

# Extract values from YAML
IMEI=$(sed -n 's/^[[:space:]]*imei:[[:space:]]*"\([^"]*\)".*/\1/p' "$CONFIG_FILE")
SLOT=$(sed -n 's/^[[:space:]]*slot:[[:space:]]*\([0-9]\+\).*/\1/p' "$CONFIG_FILE")
REFRESH=$(sed -n 's/^[[:space:]]*refresh:[[:space:]]*\(true\|false\).*/\1/p' "$CONFIG_FILE")

if [ -z "$IMEI" ] || [ -z "$SLOT" ] || [ -z "$REFRESH" ]; then
  echo '{"ok": false, "message": "Failed to parse configuration"}'
  exit 1
fi

# Return JSON response
cat <<EOF
{
  "ok": true,
  "data": {
    "imei": "$IMEI",
    "slot": $SLOT,
    "refresh": $REFRESH
  }
}
EOF