#!/bin/bash
set -u

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
. "$SCRIPT_DIR/session_utils.sh"

if ! session_load; then
    send_json_response 401 '{"status":"error","message":"Authentication required"}'
    exit 0
fi

CONFIG_FILE="/etc/data/mobileap_cfg.xml"

get_xml_value() {
    local key=$1
    local file=$2
    grep "<$key>" "$file" | sed "s/.*<$key>\(.*\)<\/$key>.*/\1/" | tr -d ' '
}

current_ip=$(get_xml_value "APIPAddr" "$CONFIG_FILE")

# Validate IP address
if [ -z "${current_ip}" ]; then
    send_json_response 500 '{"status":"error","message":"Failed to retrieve LAN IP address"}'
    exit 1
fi

# Build JSON payload
json_payload=$(cat <<EOF
{
  "status":"ok",
  "lanip":"${current_ip}"
}
EOF
)

send_json_response 200 "$json_payload"