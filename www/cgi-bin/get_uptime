#!/bin/bash
set -eu

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
. "$SCRIPT_DIR/session_utils.sh"

if ! session_load; then
    send_json_response 401 '{"status":"error","message":"Authentication required"}'
    exit 0
fi

# Execute the uptime command and parse the result
uptime_output=$(uptime)

# Parse uptime components
days=0
hours=0
minutes=0

# Extract days (e.g., "3 days")
if [[ $uptime_output =~ ([0-9]+)\ day ]]; then
    days=${BASH_REMATCH[1]}
fi

# Extract hours and minutes (e.g., "2:41")
if [[ $uptime_output =~ ([0-9]+):([0-9]+), ]]; then
    hours=$((10#${BASH_REMATCH[1]}))
    minutes=$((10#${BASH_REMATCH[2]}))
fi

# Extract load average
load_avg=""
if [[ $uptime_output =~ load\ average:\ ([0-9.]+,\ [0-9.]+,\ [0-9.]+) ]]; then
    load_avg=${BASH_REMATCH[1]}
fi

# Build JSON payload
json_payload=$(cat <<EOF
{
  "status":"ok",
  "days":${days},
  "hours":${hours},
  "minutes":${minutes},
  "load_average":"${load_avg}",
  "raw":"${uptime_output}"
}
EOF
)

send_json_response 200 "$json_payload"