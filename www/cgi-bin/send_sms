#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
. "$SCRIPT_DIR/session_utils.sh"

if ! session_load; then
    printf 'Status: 401 Unauthorized\r\n'
    printf 'Content-type: text/plain\r\n\r\n'
    printf 'Authentication required\n'
    exit 0
fi

if ! session_require_role "admin"; then
    printf 'Status: 403 Forbidden\r\n'
    printf 'Content-type: text/plain\r\n\r\n'
    printf 'Admin privileges required\n'
    exit 0
fi

QUERY_STRING=$(echo "${QUERY_STRING}" | sed 's/;//g')
urldecode() {
    local data
    data="${*//+/ }"
    echo -e "${data//%/\\x}"
}

if [ "${QUERY_STRING}" ]; then
    export IFS="&"
    for cmd in ${QUERY_STRING}; do
        if [[ "$cmd" == *=* ]]; then
            key=$(echo "$cmd" | awk -F '=' '{print $1}')
            value=$(echo "$cmd" | awk -F '=' '{print $2}')
            eval "$key"="$(urldecode "$value")"
        fi
    done
fi

phone_number="$number"
message_encoded="$msg"


send_at_command() {
    local cmd=$1
    atcli_smd8 "$cmd" 2>&1)
}

send_at_command "AT+CMGS=\"$phone_number\","$Command""
runcmd=$((echo -en "$message_encoded"; echo -en "\x1A") | microcom -t 500 /dev/ttyOUT2)
echo "$runcmd"