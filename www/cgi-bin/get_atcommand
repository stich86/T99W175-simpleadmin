#!/bin/bash
set -eu

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=/dev/null
. "$SCRIPT_DIR/session_utils.sh"

if ! session_load; then
  printf 'Status: 401 Unauthorized\r\n'
  printf 'Content-type: text/plain\r\n\r\n'
  printf 'Authentication required\n'
  exit 0
fi

urldecode() {
  local data="${1//+/ }"
  printf '%b' "${data//%/\\x}"
}

raw_query="${QUERY_STRING:-}"

atcmd_param=""
if [ -n "$raw_query" ]; then
  IFS='&' read -r -a pairs <<< "$raw_query"
  for pair in "${pairs[@]}"; do
    key="${pair%%=*}"
    value="${pair#*=}"
    if [ "$key" = "atcmd" ]; then
      atcmd_param="$value"
    fi
  done
fi

send_response() {
  local command_output="$1"
  local message="$2"
  printf 'Content-type: text/plain\r\n\r\n'
  printf '%s\n\n' "$command_output"
  printf '%s\n' "$message"
}

if [ -z "$atcmd_param" ]; then
  send_response "ERROR" "Missing atcmd parameter."
  exit 0
fi

decoded_atcmd="$(urldecode "$atcmd_param")"

if [ -z "$decoded_atcmd" ]; then
  send_response "ERROR" "Unable to decode the atcmd parameter."
  exit 0
fi

if ! command -v atcli_smd8 >/dev/null 2>&1; then
  send_response "$decoded_atcmd" "ERROR: atcli_smd8 command not found."
  exit 0
fi

max_attempts=5
attempt=1
runcmd=""
exit_code=1
busy_detected=false

while [ $attempt -le $max_attempts ]; do
  runcmd="$(atcli_smd8 "$decoded_atcmd" 2>&1)"
  exit_code=$?

  if [ $exit_code -eq 0 ]; then
    if echo "$runcmd" | grep -qiE 'device busy|resource busy|port busy|in use'; then
      busy_detected=true
    fi
    if echo "$runcmd" | grep -qE 'OK|ERROR'; then
      break
    fi
  else
    if echo "$runcmd" | grep -qiE 'busy|in use|locked'; then
      busy_detected=true
    fi
  fi

  if [ $attempt -lt $max_attempts ]; then
    sleep 1
  fi

  attempt=$((attempt + 1))
done

status_output="$runcmd"

if [ $exit_code -ne 0 ]; then
  if [ "$busy_detected" = true ]; then
    status_output="ERROR: modem busy or port in use.\n${runcmd}"
  else
    status_output="ERROR: atcli_smd8 exited with code ${exit_code}.\n${runcmd}"
  fi
fi

if [ -z "$status_output" ]; then
  status_output="ERROR: empty response from modem."
fi

send_response "$decoded_atcmd" "$status_output"
