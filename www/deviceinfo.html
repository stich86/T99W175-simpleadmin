<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Simple T99</title>
    <!-- Import all the bootstrap css files from css folder -->
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />

    <!--  Import BootStrap Javascript -->
    <script src="js/auth.js" defer></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/alpinejs.min.js" defer></script>
  </head>
  <body data-require-auth="true">
    <main>
      <div class="container my-4" x-data="fetchDeviceInfo()">
        <nav class="navbar navbar-expand-lg mt-2">
          <div class="container-fluid">
            <a class="navbar-brand" href="/"
              ><span class="mb-0 h4">Simple T99</span></a
            >
            <button
              class="navbar-toggler"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#navbarText"
              aria-controls="navbarText"
              aria-expanded="false"
              aria-label="Toggle navigation"
              data-allow-user="true"
            >
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarText">
              <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                  <a class="nav-link" href="/">Home</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="/network.html">4G/5G Settings</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="/network-settings.html">Network Settings</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="/settings.html">AT Terminal</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="/sms.html">SMS</a>
                </li>
                <li class="nav-item">
                  <a
                    class="nav-link active"
                    href="/deviceinfo.html"
                    aria-current="page"
                    >Device Information</a
                  >
                </li>
                <li class="nav-item" data-requires-admin="hide">
                  <a class="nav-link" href="/credentials.html"
                    >Gestione Credenziali</a
                  >
                </li>
              </ul>
              <div
                class="navbar-text d-flex align-items-center gap-3 flex-wrap justify-content-end"
              >
                <span
                  class="badge rounded-pill fw-semibold text-uppercase d-none"
                  id="navUserRole"
                ></span>
                <span class="fw-semibold" id="navUserName"></span>
                <button
                  class="btn btn-outline-secondary btn-sm"
                  id="logoutButton"
                  type="button"
                >
                  Logout
                </button>
                <button
                  class="btn btn-link text-reset"
                  id="darkModeToggle"
                  type="button"
                  data-allow-user="true"
                >
                  Dark Mode
                </button>
              </div>
            </div>
          </div>
        </nav>

        <div class="row mt-5 gap-3">
          <div class="col">
            <div class="card">
              <div class="card-header">Device Information</div>
              <div class="card-body">
                <div class="card-text">
                  <div class="table-responsive">
                   <table class="table">
  <tbody>
    <tr>
      <th scope="row">Manufacturer</th>
      <td x-text="manufacturer"></td>
    </tr>
    <tr>
      <th scope="row">Model Name</th>
      <td x-text="modelName"></td>
    </tr>
    <tr>
      <th scope="row">Firmware version</th>
      <td class="col-md-2" x-text="firmwareVersion"></td>
    </tr>
    <tr>
      <th scope="row">Phone Number</th>
      <td class="col-md-2" x-text="phoneNumber"></td>
    </tr>
    <tr>
      <th scope="row">IMSI</th>
      <td class="col-md-2" x-text="imsi"></td>
    </tr>
    <tr>
      <th scope="row">ICCID</th>
      <td class="col-md-2" x-text="iccid"></td>
    </tr>
    <tr>
  <th scope="row">IMEI</th>
  <td class="col-md-2" x-text="imei"></td>
   </tr>
    <tr>
      <th scope="row">LAN IP</th>
      <td class="col-md-2" x-text="lanIp"></td>
    </tr>
    <tr>
      <th scope="row">WWAN IPv<sup>4</sup></th>
      <td class="col-md-2" x-text="wwanIpv4"></td>
    </tr>
    <tr>
      <th scope="row">WWAN IPv<sup>6</sup></th>
      <td class="col-md-2" x-text="wwanIpv6"></td>
    </tr>
    <tr>
      <th scope="row">Simple T99 Version</th>
      <td class="col-md-2" x-text="simpleAdminVersion"></td>
    </tr>
  </tbody>
</table>

                  </div>
                </div>
              </div>
              <div class="card-footer">
                Visit our
                <a
                  href="https://github.com/iamromulan/quectel-rgmii-toolkit/tree/development"
                  target="_blank"
                  class="text-reset"
                  >repository</a
                >
                or
                <a
                  href="https://github.com/iamromulan/quectel-rgmii-configuration-notes.git"
                  target="_blank"
                  class="text-reset"
                  >documentation</a
                >
                for more information. All rights reserved. 2025
              </div>
            </div>
          </div>
        </div>

        <!-- Loading Modal for Reboot -->
        <div class="modal-overlay" x-show="showModal">
          <div class="loading-modal">
            <div
              class="loading-text"
              style="display: flex; flex-direction: column"
            >
              <h3>This will reboot the modem.</h3>
              <p style="margin-top: 0.5rem">Continue?</p>
            </div>
            <div class="d-grid gap-2 d-md-block">
              <button
                class="btn btn-primary"
                type="button"
                @click="updateIMEI()"
              >
                Reboot
              </button>
              <button
                class="btn btn-danger"
                type="button"
                @click="closeModal()"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>

        <!-- Reboot Modal Countdown -->
        <div class="modal-overlay" x-show="isRebooting">
          <div class="loading-modal">
            <div class="loader"></div>
            <div
              class="loading-text"
              style="display: flex; flex-direction: column"
            >
              <h3>Rebooting...</h3>
              <p style="margin-top: 0.5rem">
                Please wait for
                <span x-text="countdown" style="font-weight: 500"></span>
                seconds.
              </p>
            </div>
          </div>
        </div>
      </div>
    </main>
    <script src="js/atcommand-utils.js"></script>
    <script src="js/dark-mode.js"></script>
    <script>
      function fetchDeviceInfo() {
        return {
          manufacturer: "-",
          modelName: "-",
          firmwareVersion: "-",
          imsi: "-",
          iccid: "-",
          imei: "-",
          newImei: null,
          lanIp: "-",
          wwanIpv4: "-",
          wwanIpv6: "-",
          phoneNumber: "Unknown",
          simpleAdminVersion: "-",
          atcmd: null,
          atCommandResponse: "",
          errorMessage: "",
          showError: false,
          showModal: false,
          isLoading: false,
          isRebooting: false,
          countdown: 3,

          handleError(message, data = "") {
            this.errorMessage = message;
            this.showError = true;
            if (data) {
              this.atCommandResponse = data;
            }
            console.error("AT command error:", message);
          },

          async sendATCommand() {
            if (!this.atcmd) {
              // Use ATI as default command
              console.log(
                "AT Command is empty, using ATI as default command: "
              );
            }

            this.isLoading = true;

            try {
              const result = await ATCommandService.execute(this.atcmd, {
                retries: 3,
                timeout: 12000,
              });

              if (!result.ok) {
                const message = result.error
                  ? result.error.message
                  : "Unknown error while executing the command.";
                this.handleError(message, result.data);
                return;
              }

              this.atCommandResponse = result.data;
              this.showError = false;
            } catch (error) {
              this.handleError(error.message || "Network error while executing the command.");
            } finally {
              this.isLoading = false;
            }
          },

          async fetchATCommand() {
            this.atcmd =
              'AT+CGMI;+CGMM;^VERSION?;+CIMI;+ICCID;+CGSN;+CNUM;+CGCONTRDP=1';
            this.isLoading = true;
            try {
              const result = await ATCommandService.execute(this.atcmd, {
                retries: 3,
                timeout: 15000,
              });

              if (!result.ok) {
                const message = result.error
                  ? result.error.message
                  : "Unable to retrieve modem information.";
                this.handleError(message, result.data);
                return;
              }

              this.atCommandResponse = result.data;
              this.showError = false;
              this.parseFetchedData();
            } catch (error) {
              this.handleError(error.message || "Network error while retrieving modem information.");
            } finally {
              this.isLoading = false;
            }
          },

          fetchlanIp() {
            fetch("/cgi-bin/get_lanip")
              .then((res) => res.json())
              .then((data) => {
                this.lanIp = data.lanip;
              });
          },

          parseFetchedData() {
  if (!this.atCommandResponse) {
    this.handleError("Empty AT response from the modem.");
    this.isLoading = false;
    return;
  }

  const lines = this.atCommandResponse
    .split(/\r?\n/)
    .map(l => l.trim())
    .filter(l => l && l !== "OK");

  console.log("AT Command Response:", lines);

  let ctx = null;

  let manufacturer = this.manufacturer || "-";
  let modelName = this.modelName || "-";
  let firmwareVersion = this.firmwareVersion || "-";
  let imsi = this.imsi || "";
  let iccid = this.iccid || "";
  let imei = this.imei || "-";
  let phoneNumber = this.phoneNumber || "Unknown";
  let wwanIpv4 = this.wwanIpv4 || "-";
  let wwanIpv6 = this.wwanIpv6 || "-";

  try {
    for (const line of lines) {
      // Record which command produced the following lines
      if (line.startsWith("AT+")) { ctx = line; continue; }

      // Firmware (e.g. ^VERSION: T99W175.F0.6...)
      if (line.startsWith("^VERSION:")) {
        const afterColon = line.split(":")[1]?.trim() || line;
        firmwareVersion = afterColon;
        // Fallback: derive the model from the prefix before the first "."
        if (modelName === "-" || !modelName) {
          const m = afterColon.match(/^([A-Za-z0-9_-]+)/);
          if (m) modelName = m[1];
        }
        continue;
      }

      // PDP (+CGCONTRDP: ...,"IPv4","IPv6",...)
      if (line.startsWith("+CGCONTRDP:")) {
        const parts = line.split(",");
        wwanIpv4 = parts[3]?.replace(/"/g, "") || "-";
        wwanIpv6 = parts[4]?.replace(/"/g, "") || "-";
        continue;
      }

      // ICCID (supports "ICCID:" and "+ICCID:")
      if (line.startsWith("ICCID:")) { iccid = line.replace("ICCID:", "").trim(); continue; }
      if (line.startsWith("+ICCID:")) { iccid = line.split(":")[1]?.replace(/"/g, "").trim() || iccid; continue; }

      // IMSI
      if (ctx?.startsWith("AT+CIMI") && /^\d{15}$/.test(line)) {
        imsi = line;
        continue;
      }
      // Fallback IMSI: 15 digits, does not start with 89 (ICCID), and is not an IMEI
      if ((!imsi || imsi === "-") && /^\d{15}$/.test(line) && !line.startsWith("89") && line !== imei) {
        imsi = line;
        continue;
      }

      // IMEI
      if (ctx?.startsWith("AT+CGSN")) {
        // It can be digits only or the string "+CGSN: 86..."
        const m = line.match(/(\d{15,17})/);
        if (m) { imei = m[1].slice(0, 15); }
        continue;
      }
      // Fallback IMEI: if "+CGSN:" appears in the line
      if (line.startsWith("+CGSN:")) {
        const m = line.match(/(\d{15,17})/);
        if (m) { imei = m[1].slice(0, 15); }
        continue;
      }
      // Final IMEI fallback: 15-17 digits that are not ICCID/IMSI (ICCID starts with 89)
      if ((imei === "-" || !imei) && /^\d{15,17}$/.test(line) && !line.startsWith("89") && line !== imsi) {
        imei = line.slice(0, 15);
        continue;
      }

      // Phone number
      if (line.startsWith("+CNUM:")) {
        const seg = line.split(",");
        const num = seg[1]?.replace(/"/g, "").trim();
        if (num) phoneNumber = num;
        continue;
      }

      // Manufacturer from AT+CGMI (next line)
      if (ctx?.startsWith("AT+CGMI")) { manufacturer = line; ctx = null; continue; }

      // Model name from AT+CGMM (next line)
      if (ctx?.startsWith("AT+CGMM")) { modelName = line; ctx = null; continue; }

      // Fallback manufacturer (known vendors)
      if (manufacturer === "-" && /QUALCOMM|QUECTEL|HUAWEI|FIBOCOM|Sierra/i.test(line)) {
        manufacturer = line;
      }
    }

    // Assign values to UI fields
    this.manufacturer = manufacturer || "-";
    this.modelName = modelName || "-";
    this.firmwareVersion = firmwareVersion || "-";
    this.imsi = imsi || " ";
    this.iccid = iccid || " ";
    this.imei = imei || "-";
    this.phoneNumber = phoneNumber || "Unknown";
    this.wwanIpv4 = wwanIpv4 || "-";
    this.wwanIpv6 = wwanIpv6 || "-";
    // Define the GUI version here
    this.simpleAdminVersion = "T99-RC01";
    this.showError = false;
  } catch (error) {
    console.error("Parsing error:", error);
    this.handleError("Unable to interpret the modem response.", this.atCommandResponse);
  } finally {
    this.isLoading = false;
  }
},

          updateIMEI() {
	    let extended = "80A" + this.newImei;

    	    // 2. Swap each pair of characters
            let swapped = "";
            for (let i = 0; i < extended.length; i += 2) {
            let pair = extended.substr(i, 2);
            if (pair.length === 2) {
               swapped += pair[1] + pair[0];
            } else {
               swapped += pair[0];
                   }
            }
		
    	    // 3. Insert commas every two characters and convert to lowercase
            let formatted = swapped.match(/.{1,2}/g).join(",").toLowerCase();
	    //console.log(formatted)
            this.atcmd = `at^nv=550,"0"';^nv=550,9,"${formatted}"`;
            this.sendATCommand();
            this.rebootDevice();
          },

          rebootDevice() {
            this.atcmd = "AT+CFUN=1,1";
            this.sendATCommand();

            this.isLoading = true;
            this.showModal = false;
            this.isRebooting = true;
            this.countdown = 40;
            const interval = setInterval(() => {
              this.countdown--;
              if (this.countdown === 0) {
                clearInterval(interval);
                this.isLoading = false;
                this.showModal = false;
                this.isRebooting = false;
                this.init();
              }
            }, 1000);
          },

          openModal() {
            if (!this.newImei) {
              alert("No new IMEI provided.");
              return;
            }

            if (this.newImei.length !== 15) {
              alert("IMEI is invalid");
              return;
            }

            if (this.newImei === this.imei) {
              alert("IMEI is the same as the current IMEI");
              return;
            }

            this.showModal = true;
          },

          closeModal() {
            this.showModal = false;
          },

          init() {
            this.fetchATCommand();
	    this.fetchlanIp();
          },
        };
      }
    </script>
  </body>
</html>
