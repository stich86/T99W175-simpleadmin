<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Simple T99</title>
    <!-- Import all the bootstrap css files from css folder -->
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />

    <!-- Logo -->
    <link rel="simpleadmin-logo" href="favicon.ico" />

    <!--  Import BootStrap Javascript -->
    <script src="js/auth.js" defer></script>
    <script src="js/bootstrap.bundle.min.js"></script>
    <script src="js/alpinejs.min.js" defer></script>
    <script src="js/esim-config.js" defer></script>
    <script src="js/index-esim.js" defer></script>
    <script src="js/network-settings.js"></script>
    <script src="js/atcommand-utils.js"></script>
    <script src="js/dark-mode.js"></script>
  </head>
  <body data-require-auth="true">
    <main>
      <div class="container my-4" x-data="networkSettings()" x-init="init()">
        <nav class="navbar navbar-expand-lg mt-2">
          <div class="container-fluid">
            <a class="navbar-brand" href="/"
              ><span class="mb-0 h4">Simple T99</span></a
            >
            <button
              class="navbar-toggler"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#navbarText"
              aria-controls="navbarText"
              aria-expanded="false"
              aria-label="Toggle navigation"
              data-allow-user="true"
            >
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarText">
              <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                  <a class="nav-link" href="/">Home</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="/network.html">4G/5G Settings</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link active" aria-current="page" href="/network-settings.html"
                    >Network Settings</a
                  >
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="/settings.html">AT Terminal</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="/sms.html">SMS</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="/deviceinfo.html">Device Information</a>
                </li>
                <li class="nav-item" id="esimNavItem" style="display: none;">
                  <a class="nav-link" href="/esim.html">eSIM</a>
                </li>                 
              </ul>
              <div
                class="navbar-text d-flex align-items-center gap-3 flex-wrap justify-content-end"
              >
                <span
                  class="badge rounded-pill fw-semibold text-uppercase d-none"
                  id="navUserRole"
                ></span>
                <span class="fw-semibold" id="navUserName"></span>
                <button
                  class="btn btn-outline-secondary btn-sm"
                  id="logoutButton"
                  type="button"
                >
                  Logout
                </button>
              </div>
            </div>
          </div>
        </nav>

        <div class="row mt-5">
          <div class="col-xl-8 col-lg-9">
            <div class="card">
              <div class="card-header">Network Settings</div>
              <div class="card-body">
                <template x-if="loadError">
                  <div class="alert alert-danger" role="alert" x-text="loadError"></div>
                </template>

                <template x-if="successMessage">
                  <div class="alert alert-success" role="alert" x-text="successMessage"></div>
                </template>

                <template x-if="restartMessage">
                  <div class="alert" :class="restartStatusClass" role="alert" x-text="restartMessage"></div>
                </template>

                <template x-if="isLoading">
                  <div class="d-flex align-items-center gap-2">
                    <div class="spinner-border" role="status" aria-hidden="true"></div>
                    <span>Loading configuration...</span>
                  </div>
                </template>

                <form
                  class="mt-3"
                  x-show="!isLoading"
                  @submit.prevent="saveSettings"
                  data-requires-admin
                >
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label" for="ipAddress">LAN IP address</label>
                      <input
                        id="ipAddress"
                        class="form-control"
                        type="text"
                        inputmode="decimal"
                        autocomplete="off"
                        :disabled="isSaving"
                        x-model.trim="form.ipAddress"
                        @change="handleIpChange"
                      />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="subnetMask">Subnet mask</label>
                      <select
                        id="subnetMask"
                        class="form-select"
                        :disabled="isSaving"
                        x-model="form.subnetMask"
                      >
                        <template x-for="option in maskOptions" :key="option.value">
                          <option :value="option.value" x-text="option.label"></option>
                        </template>
                      </select>
                    </div>
                  </div>

                  <hr class="my-4" />

                  <div class="form-check form-switch mb-3">
                    <input
                      id="dhcpEnabled"
                      class="form-check-input"
                      type="checkbox"
                      role="switch"
                      :disabled="isSaving"
                      x-model="form.dhcpEnabled"
                    />
                    <label class="form-check-label" for="dhcpEnabled">Enable DHCP server</label>
                  </div>

                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label" for="dhcpStart">DHCP range start</label>
                      <input
                        id="dhcpStart"
                        class="form-control"
                        type="text"
                        inputmode="decimal"
                        autocomplete="off"
                        :disabled="isSaving || !form.dhcpEnabled"
                        x-model.trim="form.dhcpStart"
                        @input="dhcpRangeEdited = true"
                      />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label" for="dhcpEnd">DHCP range end</label>
                      <input
                        id="dhcpEnd"
                        class="form-control"
                        type="text"
                        inputmode="decimal"
                        autocomplete="off"
                        :disabled="isSaving || !form.dhcpEnabled"
                        x-model.trim="form.dhcpEnd"
                        @input="dhcpRangeEdited = true"
                      />
                    </div>
                  </div>

                  <div class="row g-3 mt-1">
                    <div class="col-md-6 col-lg-4">
                      <label class="form-label" for="dhcpLease">Lease time (seconds)</label>
                      <input
                        id="dhcpLease"
                        class="form-control"
                        type="number"
                        min="60"
                        step="60"
                        :disabled="isSaving || !form.dhcpEnabled"
                        x-model.trim="form.dhcpLease"
                      />
                    </div>
                  </div>

                  <hr class="my-4" />

                  <div class="form-check form-switch mb-3">
                    <input
                      id="dmzEnabled"
                      class="form-check-input"
                      type="checkbox"
                      role="switch"
                      :disabled="isSaving"
                      x-model="form.dmzEnabled"
                    />
                    <label class="form-check-label" for="dmzEnabled">Enable DMZ</label>
                  </div>

                  <div class="row g-3">
                    <div class="col-md-6 col-lg-4">
                      <label class="form-label" for="dmzIp">DMZ client IP address</label>
                      <input
                        id="dmzIp"
                        class="form-control"
                        type="text"
                        inputmode="decimal"
                        autocomplete="off"
                        :disabled="isSaving || !form.dmzEnabled"
                        x-model.trim="form.dmzIp"
                      />
                    </div>
                  </div>

                  <hr class="my-4" />

                  <div class="form-check form-switch mb-3">
                    <input
                      id="bridgeEnabled"
                      class="form-check-input"
                      type="checkbox"
                      role="switch"
                      :disabled="isSaving"
                      x-model="form.bridgeEnabled"
                    />
                    <label class="form-check-label" for="bridgeEnabled">Enable bridge mode (IP passthrough)</label>
                  </div>

                  <div class="row g-3">
                    <div class="col-md-6 col-lg-4">
                      <label class="form-label" for="bridgeMac">Bridge client MAC address</label>
                      <input
                        id="bridgeMac"
                        class="form-control"
                        type="text"
                        inputmode="text"
                        autocomplete="off"
                        placeholder="AA:BB:CC:DD:EE:FF"
                        :disabled="isSaving || !form.bridgeEnabled"
                        x-model.trim="form.bridgeMac"
                        @input="form.bridgeMac = form.bridgeMac.toUpperCase()"
                      />
                      <div class="form-text">
                        When bridge mode is enabled, the selected device receives the public IP directly and the router interface remains on the LAN subnet.
                      </div>
                    </div>
                  </div>

                  <template x-if="form.bridgeEnabled">
                    <div class="alert alert-warning mt-3" role="alert">
                      While bridge mode is active, the selected client will receive its address directly from the mobile network and skip the LAN DHCP pool. Access to the router interface may only be possible from devices that remain on the LAN subnet.
                    </div>
                  </template>

                  <hr class="my-4" />

                  <div class="form-check form-switch mb-3">
                    <input
                      id="ipv6Enabled"
                      class="form-check-input"
                      type="checkbox"
                      role="switch"
                      :disabled="isSaving"
                      x-model="form.ipv6Enabled"
                    />
                    <label class="form-check-label" for="ipv6Enabled">Enable IPv6</label>
                  </div>

                  <hr class="my-4" />

                  <div class="form-check form-switch mb-3">
                    <input
                      id="ttlEnabled"
                      class="form-check-input"
                      type="checkbox"
                      role="switch"
                      :disabled="ttlSaving"
                      x-model="form.ttlEnabled"
                      @change="applyTtlImmediately"
                    />
                    <label class="form-check-label" for="ttlEnabled">
                      Enable Custom TTL
                      <span x-show="ttlSaving" class="spinner-border spinner-border-sm ms-2" role="status"></span>
                    </label>
                  </div>

                  <div class="row g-3">
                    <div class="col-md-6 col-lg-5">
                      <label class="form-label" for="ttlValue">TTL Value</label>
                      <div class="input-group">
                        <input
                          id="ttlValue"
                          class="form-control"
                          type="number"
                          min="1"
                          max="255"
                          inputmode="numeric"
                          autocomplete="off"
                          placeholder="64"
                          :disabled="ttlSaving || !form.ttlEnabled"
                          x-model.number="form.ttlValue"
                          @keydown.enter="applyTtlImmediately"
                        />
                        <button
                          class="btn btn-outline-primary"
                          type="button"
                          :disabled="ttlSaving || !form.ttlEnabled || !form.ttlValue"
                          @click="applyTtlImmediately"
                        >
                          <span x-show="!ttlSaving">Apply</span>
                          <span x-show="ttlSaving">
                            <span class="spinner-border spinner-border-sm" role="status"></span>
                          </span>
                        </button>
                      </div>
                      <div class="form-text">
                        Set a value between 1 and 255. Changes are applied immediately without restarting the modem.
                      </div>
                    </div>
                  </div>

                  <template x-if="ttlSuccessMessage">
                    <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                      <span x-text="ttlSuccessMessage"></span>
                      <button type="button" class="btn-close" @click="ttlSuccessMessage = ''"></button>
                    </div>
                  </template>

                  <template x-if="ttlErrorMessage">
                    <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                      <span x-text="ttlErrorMessage"></span>
                      <button type="button" class="btn-close" @click="ttlErrorMessage = ''"></button>
                    </div>
                  </template>

                  <template x-if="form.ttlEnabled && form.ttlValue">
                    <div class="alert alert-info mt-3" role="alert">
                      <strong>Custom TTL active:</strong> Packets will be sent with TTL value of <span x-text="form.ttlValue"></span>.
                    </div>
                  </template>

                  <hr class="my-4" />

                  <div class="mb-3">
                    <div class="d-flex align-items-center gap-2 mb-1">
                      <h5 class="mb-0">Riavvio automatico</h5>
                      <span class="badge text-bg-light">Salvato in reboot.txt (cron)</span>
                    </div>
                    <p class="text-body-secondary mb-3">
                      Imposta un riavvio pianificato: l'impostazione viene salvata in formato compatibile con cron e potrai modificarla o cancellarla in seguito.
                    </p>

                    <div class="btn-group mb-3" role="group" aria-label="Auto reboot options">
                      <button
                        type="button"
                        class="btn"
                        :class="rebootForm.mode === 'interval' ? 'btn-primary' : 'btn-outline-primary'"
                        @click="rebootForm.mode = 'interval'"
                        :disabled="rebootSaving"
                      >
                        Ogni X ore
                      </button>
                      <button
                        type="button"
                        class="btn"
                        :class="rebootForm.mode === 'schedule' ? 'btn-primary' : 'btn-outline-primary'"
                        @click="rebootForm.mode = 'schedule'"
                        :disabled="rebootSaving"
                      >
                        Programmazione
                      </button>
                    </div>

                    <div class="row g-3" x-show="rebootForm.mode === 'interval'">
                      <div class="col-md-4 col-lg-3">
                        <label class="form-label" for="rebootIntervalHours">Ogni quante ore?</label>
                        <div class="input-group">
                          <input
                            id="rebootIntervalHours"
                            class="form-control"
                            type="number"
                            min="1"
                            max="720"
                            :disabled="rebootSaving"
                            x-model.number="rebootForm.intervalHours"
                          />
                          <span class="input-group-text">ore</span>
                        </div>
                        <div class="form-text">Esegue un riavvio ogni N ore (es. 12 =&gt; <code>0 */12 * * * reboot</code>).</div>
                      </div>
                    </div>

                    <div class="row g-3" x-show="rebootForm.mode === 'schedule'">
                      <div class="col-md-4 col-lg-3">
                        <label class="form-label" for="rebootFrequency">Frequenza</label>
                        <select
                          id="rebootFrequency"
                          class="form-select"
                          :disabled="rebootSaving"
                          x-model="rebootForm.frequency"
                        >
                          <option value="daily">Ogni giorno</option>
                          <option value="weekly">Ogni settimana</option>
                          <option value="monthly">Ogni mese</option>
                        </select>
                      </div>

                      <div class="col-md-4 col-lg-3" x-show="rebootForm.frequency === 'weekly'">
                        <label class="form-label" for="rebootDayOfWeek">Giorno</label>
                        <select
                          id="rebootDayOfWeek"
                          class="form-select"
                          :disabled="rebootSaving"
                          x-model="rebootForm.dayOfWeek"
                        >
                          <option value="1">Lunedì</option>
                          <option value="2">Martedì</option>
                          <option value="3">Mercoledì</option>
                          <option value="4">Giovedì</option>
                          <option value="5">Venerdì</option>
                          <option value="6">Sabato</option>
                          <option value="0">Domenica</option>
                        </select>
                      </div>

                      <div class="col-md-4 col-lg-3" x-show="rebootForm.frequency === 'monthly'">
                        <label class="form-label" for="rebootDayOfMonth">Giorno del mese</label>
                        <input
                          id="rebootDayOfMonth"
                          class="form-control"
                          type="number"
                          min="1"
                          max="31"
                          :disabled="rebootSaving"
                          x-model.number="rebootForm.dayOfMonth"
                        />
                        <div class="form-text">Esempio: 1 = ogni primo del mese.</div>
                      </div>

                      <div class="col-md-4 col-lg-3">
                        <label class="form-label" for="rebootTime">Orario</label>
                        <input
                          id="rebootTime"
                          class="form-control"
                          type="time"
                          step="60"
                          :disabled="rebootSaving"
                          x-model="rebootForm.time"
                        />
                        <div class="form-text">Esempi: 00:00 (mezzanotte), 16:00 (ogni giorno alle 16).</div>
                      </div>
                    </div>

                    <div class="d-flex flex-wrap gap-2 mt-3">
                      <button
                        type="button"
                        class="btn btn-primary"
                        :disabled="rebootSaving"
                        @click="saveRebootSchedule()"
                      >
                        Salva pianificazione
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-secondary"
                        :disabled="rebootSaving"
                        @click="loadRebootSchedule()"
                      >
                        Annulla modifiche
                      </button>
                      <button
                        type="button"
                        class="btn btn-outline-danger"
                        :disabled="rebootSaving || !rebootSchedule"
                        @click="clearRebootSchedule()"
                      >
                        Rimuovi pianificazione
                      </button>
                    </div>

                    <template x-if="rebootSuccessMessage">
                      <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                        <span x-text="rebootSuccessMessage"></span>
                        <button type="button" class="btn-close" @click="rebootSuccessMessage = ''"></button>
                      </div>
                    </template>

                    <template x-if="rebootErrorMessage">
                      <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                        <span x-text="rebootErrorMessage"></span>
                        <button type="button" class="btn-close" @click="rebootErrorMessage = ''"></button>
                      </div>
                    </template>

                    <template x-if="rebootSchedule">
                      <div class="alert alert-info mt-3" role="alert">
                        <strong>Pianificazione corrente:</strong>
                        <code x-text="rebootSchedule"></code>
                      </div>
                    </template>
                  </div>

                  <template x-if="validationErrors.length">
                    <div class="alert alert-warning mt-4" role="alert">
                      <h6 class="alert-heading">Please review the following:</h6>
                      <ul class="mb-0">
                        <template x-for="(error, index) in validationErrors" :key="index">
                          <li x-text="error"></li>
                        </template>
                      </ul>
                    </div>
                  </template>

                  <p class="text-body-secondary mt-4 mb-2">
                    Saving the configuration will restart the modem to apply the changes.
                  </p>

                  <div class="d-flex gap-2 justify-content-end mt-3">
                    <button type="button" class="btn btn-outline-secondary" :disabled="isSaving" @click="resetForm">
                      Reset
                    </button>
                    <button type="submit" class="btn btn-primary" :disabled="isSaving">
                      <template x-if="!isSaving">
                        <span>Save changes</span>
                      </template>
                      <template x-if="isSaving">
                        <span class="d-flex align-items-center gap-2">
                          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                          <span>Saving...</span>
                        </span>
                      </template>
                    </button>                    
                  </div>
                 

                </form>

              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <footer class="border-top py-3 mt-4">
      <div class="container d-flex flex-wrap gap-3 justify-content-between align-items-center">
        <a class="btn btn-outline-secondary btn-sm" href="/credentials.html" data-requires-admin="hide">Credential Management</a>
        <button class="btn btn-link text-reset" id="darkModeToggle" type="button" data-allow-user="true">Dark Mode</button>
      </div>
    </footer>
  </body>
</html>
